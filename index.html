<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Juego del Impostor</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico?v=2">
  <link rel="stylesheet" href="styles.css">
  
</head>
<body>
  <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()">&#9728;&#65039;</button>
  <div class="mesh-gradient"></div>
  <div class="blob blob1"></div>
  <div class="blob blob2"></div>
  <div class="blob blob3"></div>
  <div class="countdown-overlay" id="countdownOverlay">
    <div class="countdown-number" id="countdownNumber">3</div>
  </div>
  <div class="background-symbols" id="symbols"></div>
  <div class="card">
    <h2>Juego del Impostor</h2>
    <p id="mensaje">Crea una sala o Ãºnete con un cÃ³digo</p>
    
    <!-- Indicador de categorÃ­a -->
    <div class="categoria-indicator" id="categoriaIndicator">
      CategorÃ­a: <span id="categoriaTexto">Aleatoria</span>
      <button class="btn-info-roles" onclick="toggleCategoriaSelector()" style="margin-left: 8px;">Cambiar</button>
    </div>

    <!-- Indicador de modo de juego -->
    <div class="modo-indicator" id="modoIndicator">
      Modo: <span id="modoTexto">Normal</span>
      <button class="btn-info-roles" id="btnInfoRoles" onclick="toggleInfoRoles()" style="display: none;">â„¹ï¸ Info Roles</button>
    </div>
    
    <!-- Panel de informaciÃ³n de roles -->
    <div class="roles-info" id="rolesInfo">
      <h3>ğŸ­ Roles Disponibles</h3>
      <div class="roles-list">
        <div class="role-item ciudadano">
          <div class="role-header">
            <div class="role-icon">ğŸŸ¢</div>
            <div class="role-title">Ciudadano</div>
          </div>
          <div class="role-desc">Conoce la palabra secreta. Tu objetivo es encontrar al impostor sin revelar la palabra.</div>
        </div>
        <div class="role-item impostor">
          <div class="role-header">
            <div class="role-icon">ğŸ”´</div>
            <div class="role-title">Impostor</div>
          </div>
          <div class="role-desc">No conoce la palabra. Debe engaÃ±ar a los demÃ¡s haciÃ©ndose pasar por ciudadano.</div>
        </div>
        <div class="role-item confundido">
          <div class="role-header">
            <div class="role-icon">ğŸŸ </div>
            <div class="role-title">Confundido</div>
          </div>
          <div class="role-desc">Tiene una palabra DIFERENTE a los ciudadanos. Cree que es ciudadano pero estÃ¡ confundido.</div>
        </div>
        <div class="role-item saboteador">
          <div class="role-header">
            <div class="role-icon">ğŸŸ£</div>
            <div class="role-title">Saboteador</div>
          </div>
          <div class="role-desc">Sabe la palabra real pero ayuda al impostor. Da pistas falsas para confundir al grupo.</div>
        </div>
      </div>
    </div>
    
    <!-- NUEVO: Mostrar URL completa -->
    <div class="url-display" id="urlDisplay"></div>
    
    <div class="codigo-sala" id="codigoSalaDisplay">
      <span id="codigoTexto"></span>
      <!-- QUITAMOS el botÃ³n de copiar cÃ³digo y dejamos solo el de copiar URL -->
      <button class="btn-copiar" onclick="copiarURL()">Copiar URL</button>
      <!-- NUEVO: BotÃ³n para volver al inicio -->
      <button class="btn-volver" onclick="volverAlInicio()">Volver al Inicio</button>
    </div>
    
    <!-- Selector de modo de juego -->
    <div class="modo-selector" id="modoSelector">
      <h3>Selecciona el modo de juego:</h3>
      <div class="modo-options">
        <div class="modo-option selected" data-modo="normal">
          <div class="modo-icon">ğŸ¯</div>
          <div class="modo-info">
            <div class="modo-title">Modo Normal</div>
            <div class="modo-desc">Un impostor vs. el resto con la misma palabra</div>
          </div>
        </div>
        <div class="modo-option" data-modo="masRoles">
          <div class="modo-icon">ğŸ­</div>
          <div class="modo-info">
            <div class="modo-title">MÃ¡s Roles</div>
            <div class="modo-desc">Incluye Confundido y Saboteador para mÃ¡s caos</div>
          </div>
        </div>
      </div>
      <!-- BOTÃ“N PARA CONTINUAR A CATEGORÃA -->
      <button onclick="continuarACategoria()" style="margin-top: 15px; padding: 10px; background: var(--button-bg); color: var(--button-text); border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
      Continuar a SelecciÃ³n de CategorÃ­a
      </button>
    </div>
    
    <!-- Selector de color -->
    <div class="color-selector" id="colorSelector">
      <h3>Elige tu color:</h3>
      <div class="colores-disponibles" id="coloresDisponibles">
        <!-- Los colores se generarÃ¡n dinÃ¡micamente con JavaScript -->
      </div>
    </div>
    
    <div class="jugadores-info" id="jugadoresInfo">
      <h3>Jugadores en sala: <span id="contadorJugadores">0</span></h3>
      <ul class="lista-jugadores" id="listaJugadores"></ul>
    </div>
    
    <input id="nombreJugador" type="text" placeholder="Tu nombre"><br>
    <button onclick="crearSala()">Crear Sala</button><br>
    <input id="codigoSala" placeholder="CÃ³digo de sala">
    <button onclick="unirseSala()">Unirse</button><br>
    <button id="botonAsignar" onclick="asignarRoles()">Asignar Roles (Host)</button>
    <button id="botonNuevaRonda" onclick="nuevaRonda()">Nueva Ronda</button>
  </div>
  
  <!-- CHAT CONTAINER - FUERA DE LA TARJETA PRINCIPAL Y SIN BOTÃ“N DE CERRAR -->
  <div class="chat-container" id="chatContainer">
    <div class="chat-header">
      <h3>ğŸ’¬ Chat</h3>
      <!-- Eliminamos el botÃ³n de cerrar -->
    </div>
    <div class="chat-messages" id="chatMessages"></div>
    <div class="reacciones-container">
      <button class="btn-reaccion" onclick="enviarReaccion('ğŸ‘')" title="Me gusta">ğŸ‘</button>
      <button class="btn-reaccion" onclick="enviarReaccion('ğŸ‘')" title="No me gusta">ğŸ‘</button>
      <button class="btn-reaccion" onclick="enviarReaccion('ğŸ¤”')" title="Sospechoso">ğŸ¤”</button>
      <button class="btn-reaccion" onclick="enviarReaccion('ğŸ˜±')" title="Sorpresa">ğŸ˜±</button>
      <button class="btn-reaccion" onclick="enviarReaccion('ğŸ¤£')" title="Risa">ğŸ¤£</button>
      <button class="btn-reaccion" onclick="enviarReaccion('â˜ ï¸')" title="Calavera">â˜ ï¸</button>
    </div>
    <div class="chat-input-container">
      <input id="chatInput" type="text" placeholder="Escribe un mensaje..." onkeypress="handleChatKeyPress(event)">
      <button onclick="enviarMensaje()">Enviar</button>
    </div>
  </div>
  
  <!-- Selector de categorÃ­as flotante -->
  <div class="categoria-container" id="categoriaContainer">
    <div class="categoria-header">
      <h3>ğŸ¯ Selecciona una categorÃ­a</h3>
      <button class="categoria-close" onclick="toggleCategoriaSelector()">Ã—</button>
    </div>
    <div class="categoria-options">
      <div class="categoria-option selected" data-categoria="aleatoria">
        <div class="categoria-icon">ğŸ²</div>
        <div class="categoria-info">
          <div class="categoria-title">Aleatoria</div>
          <div class="categoria-desc">Palabras de todas las categorÃ­as</div>
        </div>
      </div>
      <div class="categoria-option" data-categoria="actores">
        <div class="categoria-icon">ğŸ­</div>
        <div class="categoria-info">
          <div class="categoria-title">Actores</div>
          <div class="categoria-desc">Actores y actrices famosos</div>
        </div>
      </div>
      <div class="categoria-option" data-categoria="series">
        <div class="categoria-icon">ğŸ“º</div>
        <div class="categoria-info">
          <div class="categoria-title">Series</div>
          <div class="categoria-desc">Series de TV y personajes</div>
        </div>
      </div>
      <div class="categoria-option" data-categoria="videojuegos">
        <div class="categoria-icon">ğŸ®</div>
        <div class="categoria-info">
          <div class="categoria-title">Videojuegos</div>
          <div class="categoria-desc">Personajes y elementos de videojuegos</div>
        </div>
      </div>
      <div class="categoria-option" data-categoria="anime">
        <div class="categoria-icon">ğŸ—¾</div>
        <div class="categoria-info">
          <div class="categoria-title">Anime</div>
          <div class="categoria-desc">Personajes de anime y manga</div>
        </div>
      </div>
      <div class="categoria-option" data-categoria="artistas">
        <div class="categoria-icon">ğŸ¤</div>
        <div class="categoria-info">
          <div class="categoria-title">Artistas</div>
          <div class="categoria-desc">Cantantes o bandas famosas</div>
      </div>
    </div>
    <button class="btn-confirmar-categoria" onclick="confirmarCategoria()" style="margin-top: 15px; padding: 10px; background: var(--button-bg); color: var(--button-text); border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
    Confirmar CategorÃ­a
    </button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAnQJm-YfIgkz5HZ8ebkPqaxRICapy98N8",
      authDomain: "juego-impostor-88c68.firebaseapp.com",
      projectId: "juego-impostor-88c68",
      storageBucket: "juego-impostor-88c68.firebasestorage.app",
      messagingSenderId: "433056214911",
      appId: "1:433056214911:web:81d9f175213b4a7861f44a",
      measurementId: "G-3PKRDYMX8F"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Palabras organizadas por categorÃ­as
    const palabrasPorCategoria = {
      aleatoria: [
        "Scarlett Johansson", "Tom Holland", "Zendaya", "Chris Hemsworth", "Emma Watson", "Robert Downey Jr.", "Margot Robbie", "Dwayne Johnson", "Gal Gadot", "TimothÃ©e Chalamet", "Florence Pugh", "Will Smith", "Chris Evans", "Ryan Reynolds", "Ryan Gosling", "Millie Bobby Brown", "Leonardo DiCaprio", "Brad Pitt", "Angelina Jolie", "Jennifer Lawrence", "Tom Hanks", "Johnny Depp", "Natalie Portman", "Samuel L. Jackson", "Morgan Freeman", "Keanu Reeves", "Cillian Murphy", "Pedro Pascal", "Sydney Sweeney", "Rick (Rick y Morty)", "Morty", "Homero Simpson", "Marge Simpson", "Bart Simpson", "Lisa Simpson", "Walter White", "Jesse Pinkman", "Skyler White", "Tony Stark", "Peter Parker", "Loki", "Wanda Maximoff", "Doctor Strange", "Black Panther", "Jon Snow", "Daenerys Targaryen", "Tyrion Lannister", "Once", "Mike Wheeler", "Dustin Henderson", "Saul Goodman", "Gustavo Fring", "Rick Grimes", "Daryl Dixon", "Dexter Morgan", "Eric Cartman", "Kenny (Southpark)", "Kyle (Southpark)", "Stan (Southpark)", "Mr. Bean", "Mario", "Luigi", "Bowser", "Sonic", "Tails", "Knuckles", "Pikachu", "Ash Ketchum", "Link", "Zelda", "Kratos", "Lara Croft", "Ellie", "Joel", "Arthur Morgan", "Nathan Drake", "Donkey Kong", "Yoshi", "Kirby", "Solid Snake", "Jill Valentine", "Leon S. Kennedy", "Ada Wong", "Goku", "Vegeta", "Bulma", "Naruto", "Sasuke", "Sakura", "Luffy", "Zoro", "Nami", "Sanji", "Light Yagami", "L", "Mikasa Ackerman", "Eren Yeager", "Levi Ackerman", "Edward Elric", "Alphonse Elric", "Spike Spiegel", "Faye Valentine", "Sailor Moon", "Monkey D. Luffy", "Roronoa Zoro", "Satoru Gojo", "Yuji Itadori", "Nezuko Kamado", "Tanjiro Kamado", "Levi Ackerman", "Eren Yeager", "Mikasa Ackerman", "Justin Bieber", "The Weeknd", "Zell", "Duki", "Neo Pistea", "YSY A", "Drake", "Taylor Swift", "Kanye West", "C.R.O", "Lana del Rey", "Quevedo", "Bizarrap", "Shakira", "Daddy Yankee", "Tiago PZK", "Milo J", "Nicki Nicole", "Trueno", "Maria Becerra", "Eminem", "Snoop Dogg", "50 Cent", "Travis Scott", "Kendrick Lamar", "Tyler, The Creator", "Billie Eilish", "Olivia Rodrigo", "Ariana Grande", "Dua Lipa", "Rihanna", "BeyoncÃ©", "Adele", "Imagine Dragons", "Ed Sheeran", "Harry Styles", "One Direction", "Avril Lavigne", "Saramalacara", "Michael Jackson", "Freddie Mercury", "Seven Kayne", "Ramma"
      ],
      actores: [
        "Scarlett Johansson", "Tom Holland", "Zendaya", "Chris Hemsworth", "Emma Watson", "Robert Downey Jr.", "Margot Robbie", "Dwayne Johnson", "Gal Gadot", "TimothÃ©e Chalamet", "Florence Pugh", "Will Smith", "Chris Evans", "Ryan Reynolds", "Ryan Gosling", "Millie Bobby Brown", "Leonardo DiCaprio", "Brad Pitt", "Angelina Jolie", "Jennifer Lawrence", "Tom Hanks", "Johnny Depp", "Natalie Portman", "Samuel L. Jackson", "Morgan Freeman", "Keanu Reeves", "Cillian Murphy", "Pedro Pascal", "Sydney Sweeney"
      ],
      series: [
        "Rick (Rick y Morty)", "Morty", "Homero Simpson", "Marge Simpson", "Bart Simpson", "Lisa Simpson", "Walter White", "Jesse Pinkman", "Skyler White", "Tony Stark", "Peter Parker", "Loki", "Wanda Maximoff", "Doctor Strange", "Black Panther", "Jon Snow", "Daenerys Targaryen", "Tyrion Lannister", "Once", "Mike Wheeler", "Dustin Henderson", "Saul Goodman", "Gustavo Fring", "Rick Grimes", "Daryl Dixon", "Dexter Morgan", "Eric Cartman", "Kenny (Southpark)", "Kyle (Southpark)", "Stan (Southpark)", "Mr. Bean"
      ],
      videojuegos: [
        "Mario", "Luigi", "Bowser", "Sonic", "Tails", "Knuckles", "Pikachu", "Ash Ketchum", "Link", "Zelda", "Kratos", "Lara Croft", "Ellie", "Joel", "Arthur Morgan", "Nathan Drake", "Donkey Kong", "Yoshi", "Kirby", "Solid Snake", "Jill Valentine", "Leon S. Kennedy", "Ada Wong"
      ],
      anime: [
        "Goku", "Vegeta", "Bulma", "Naruto", "Sasuke", "Sakura", "Luffy", "Zoro", "Nami", "Sanji", "Light Yagami", "L", "Mikasa Ackerman", "Eren Yeager", "Levi Ackerman", "Edward Elric", "Alphonse Elric", "Spike Spiegel", "Faye Valentine", "Sailor Moon", "Monkey D. Luffy", "Roronoa Zoro", "Satoru Gojo", "Yuji Itadori", "Nezuko Kamado", "Tanjiro Kamado", "Levi Ackerman", "Eren Yeager", "Mikasa Ackerman"
      ],
      artistas: [
        "Justin Bieber", "The Weeknd", "Zell", "Duki", "Neo Pistea", "YSY A", "Drake", "Taylor Swift", "Kanye West", "C.R.O", "Lana del Rey", "Quevedo", "Bizarrap", "Shakira", "Daddy Yankee", "Tiago PZK", "Milo J", "Nicki Nicole", "Trueno", "Maria Becerra", "Eminem", "Snoop Dogg", "50 Cent", "Travis Scott", "Kendrick Lamar", "Tyler, The Creator", "Billie Eilish", "Olivia Rodrigo", "Ariana Grande", "Dua Lipa", "Rihanna", "BeyoncÃ©", "Adele", "Imagine Dragons", "Ed Sheeran", "Harry Styles", "One Direction", "Avril Lavigne", "Saramalacara", "Michael Jackson", "Freddie Mercury", "Seven Kayne", "Ramma"
      ]
    };

    // Colores disponibles para los jugadores
    const coloresJugadores = [
      '#FF5252', '#FF4081', '#E040FB', '#7C4DFF', '#536DFE', 
      '#448AFF', '#40C4FF', '#18FFFF', '#64FFDA', '#69F0AE',
      '#B2FF59', '#EEFF41', '#FFFF00', '#FFD740', '#FFAB40',
      '#FF6E40', '#8D6E63', '#78909C', '#455A64', '#263238'
    ];

    let salaActual = null;
    let jugadorId = Math.floor(Math.random() * 1000000);
    let esHost = false;
    let miNombre = "";
    let miColor = null;
    let modoJuego = "normal"; // "normal" o "masRoles"
    let categoriaJuego = "aleatoria"; // Nueva variable para la categorÃ­a
    let cantidadJugadoresAnterior = 0;
    let juegoIniciado = false;
    let audioContext = null;
    let ultimoCountdown = null;

    // FunciÃ³n para mostrar/ocultar informaciÃ³n de roles
    window.toggleInfoRoles = function() {
  const rolesInfo = document.getElementById('rolesInfo');
  if (rolesInfo.style.display === 'none' || rolesInfo.style.display === '') {
    rolesInfo.style.display = 'block';
  } else {
    rolesInfo.style.display = 'none';
  }
};

    // Inicializar contexto de audio
    function inicializarAudio() {
  if (!audioContext) {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
  }
  // Siempre intentar reanudar el contexto (necesario para navegadores modernos)
  if (audioContext.state !== 'running') {
    audioContext.resume();
  }
}

    // Sonidos
    function reproducirSonido(frecuencia, duracion) {
      try {
        inicializarAudio();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = frecuencia;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duracion);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + duracion);
      } catch (error) {
        console.log('Error al reproducir sonido:', error);
      }
    }

    function sonidoUnirse() {
      inicializarAudio();
      reproducirSonido(600, 0.2);
      setTimeout(() => reproducirSonido(800, 0.2), 100);
    }

    function sonidoCrearSala() {
      inicializarAudio();
      reproducirSonido(523, 0.15);
      setTimeout(() => reproducirSonido(659, 0.15), 80);
      setTimeout(() => reproducirSonido(784, 0.25), 160);
    }

    function sonidoCopiar() {
      inicializarAudio();
      reproducirSonido(800, 0.1);
      setTimeout(() => reproducirSonido(1000, 0.15), 50);
    }

    function sonidoAsignarRoles() {
      inicializarAudio();
      reproducirSonido(440, 0.2);
      setTimeout(() => reproducirSonido(392, 0.2), 150);
      setTimeout(() => reproducirSonido(349, 0.2), 300);
      setTimeout(() => reproducirSonido(330, 0.4), 450);
    }

    function sonidoNuevaRonda() {
      inicializarAudio();
      reproducirSonido(698, 0.15);
      setTimeout(() => reproducirSonido(784, 0.15), 100);
      setTimeout(() => reproducirSonido(880, 0.2), 200);
    }

    function sonidoCountdown() {
      inicializarAudio();
      reproducirSonido(600, 0.3);
    }

    function sonidoCountdownFinal() {
      inicializarAudio();
      reproducirSonido(800, 0.15);
      setTimeout(() => reproducirSonido(1000, 0.3), 100);
    }

    function sonidoReaccion() {
      inicializarAudio();
      reproducirSonido(800, 0.1);
      setTimeout(() => reproducirSonido(1000, 0.1), 80);
    }
    
    function sonidoSeleccionarModo() {
      inicializarAudio();
      reproducirSonido(600, 0.1);
      setTimeout(() => reproducirSonido(800, 0.1), 50);
    }

    function sonidoSeleccionarCategoria() {
      inicializarAudio();
      reproducirSonido(500, 0.1);
      setTimeout(() => reproducirSonido(700, 0.1), 50);
      setTimeout(() => reproducirSonido(900, 0.15), 100);
    }

    function sonidoContinuar() {
      inicializarAudio();
      reproducirSonido(659, 0.1); // Mi
      setTimeout(() => reproducirSonido(784, 0.1), 80); // Sol
      setTimeout(() => reproducirSonido(880, 0.15), 160); // La
    }

    function sonidoConfirmar() {
      inicializarAudio();
      reproducirSonido(880, 0.1); // La
      setTimeout(() => reproducirSonido(784, 0.1), 80); // Sol
      setTimeout(() => reproducirSonido(659, 0.2), 160); // Mi
    }
    
    // Mostrar countdown sincronizado
    function mostrarCountdownSincronizado(valor) {
      const overlay = document.getElementById('countdownOverlay');
      const numberElement = document.getElementById('countdownNumber');
      
      console.log('Countdown valor recibido:', valor);
      
      if (valor === null || valor === -1) {
        overlay.style.display = 'none';
        ultimoCountdown = null;
        return;
      }
      
      // Solo actualizar si el valor cambiÃ³
      if (ultimoCountdown === valor) return;
      ultimoCountdown = valor;
      
      overlay.style.display = 'flex';
      
      if (valor === 0) {
        numberElement.textContent = 'Â¡COMIENZA!';
        sonidoCountdownFinal();
      } else {
        numberElement.textContent = valor;
        sonidoCountdown();
      }
      
      // Reiniciar animaciÃ³n
      numberElement.style.animation = 'none';
      void numberElement.offsetWidth;
      numberElement.style.animation = 'countdownPulse 1s ease-out';
    }

    // NUEVO: FunciÃ³n para mostrar la URL completa
    function mostrarURLCompleta() {
      const urlDisplay = document.getElementById('urlDisplay');
      urlDisplay.textContent = window.location.href;
      urlDisplay.style.display = 'block';
    }

    // MODIFICADO: Copiar URL completa (no solo el cÃ³digo)
    window.copiarURL = function() {
      if (!salaActual) return;
      sonidoCopiar();
      const urlCompleta = window.location.href;
      navigator.clipboard.writeText(urlCompleta).then(() => {
        const btn = document.querySelector('.btn-copiar');
        const textoOriginal = btn.textContent;
        btn.textContent = 'âœ“ URL Copiada!';
        setTimeout(() => {
          btn.textContent = textoOriginal;
        }, 2000);
      });
    };

    // NUEVO: FunciÃ³n para volver al inicio
    window.volverAlInicio = function() {
      if (confirm('Â¿EstÃ¡s seguro de que quieres volver al inicio? PerderÃ¡s tu conexiÃ³n a la sala actual.')) {
        // Restaurar la URL original
        history.pushState({}, '', window.location.pathname);
        
        // Recargar la pÃ¡gina para reiniciar completamente
        location.reload();
      }
    };

    // Enviar reacciÃ³n
    window.enviarReaccion = async function(emoji) {
      if (!salaActual) return;
      
      sonidoReaccion();
      
      const salaRef = doc(db, "salas", salaActual);
      await updateDoc(salaRef, {
        reacciones: arrayUnion({
          nombre: miNombre,
          emoji: emoji,
          timestamp: Date.now()
        })
      });
    };

    window.handleChatKeyPress = function(event) {
      if (event.key === 'Enter') {
        enviarMensaje();
      }
    };

    // Eliminamos la funciÃ³n toggleChat para que el chat no se pueda cerrar

    // Mostrar reacciÃ³n flotante
    function mostrarReaccionFlotante(nombre, emoji) {
      const reaccion = document.createElement('div');
      reaccion.className = 'reaccion-flotante';
      reaccion.textContent = emoji;
      
      const nombreDiv = document.createElement('div');
      nombreDiv.className = 'reaccion-nombre';
      nombreDiv.textContent = nombre;
      reaccion.appendChild(nombreDiv);
      
      // PosiciÃ³n aleatoria en la parte inferior-central de la pantalla
      const x = window.innerWidth / 2 + (Math.random() - 0.5) * 400;
      const y = window.innerHeight - 150;
      
      reaccion.style.left = x + 'px';
      reaccion.style.top = y + 'px';
      
      document.body.appendChild(reaccion);
      
      setTimeout(() => {
        reaccion.remove();
      }, 2000);
    }

    // Enviar mensaje al chat
    window.enviarMensaje = async function() {
      const input = document.getElementById('chatInput');
      const mensaje = input.value.trim();
      
      if (!mensaje || !salaActual) return;
      
      const salaRef = doc(db, "salas", salaActual);
      await updateDoc(salaRef, {
        mensajes: arrayUnion({
          nombre: miNombre,
          texto: mensaje,
          timestamp: Date.now(),
          color: miColor
        })
      });
      
      input.value = '';
    };

    // Actualizar chat
    function actualizarChat(mensajes) {
      if (!mensajes) return;
      const chatDiv = document.getElementById('chatMessages');
      chatDiv.innerHTML = '';
      const mensajesRecientes = mensajes.slice(-20);
      mensajesRecientes.forEach(msg => {
        const div = document.createElement('div');
        div.className = 'chat-message';
        
        // Aplicar color al nombre del jugador si estÃ¡ disponible
        const nombreStyle = msg.color ? `style="color: ${msg.color}"` : '';
        div.innerHTML = `<strong ${nombreStyle}>${msg.nombre}:</strong> ${msg.texto}`;
        chatDiv.appendChild(div);
      });
      chatDiv.scrollTop = chatDiv.scrollHeight;
    }

    // Actualizar lista de jugadores
    function actualizarListaJugadores(jugadores, hostId) {
  const lista = document.getElementById('listaJugadores');
  const contador = document.getElementById('contadorJugadores');
  const jugadoresKeys = Object.keys(jugadores);

  if (jugadoresKeys.length > cantidadJugadoresAnterior && cantidadJugadoresAnterior > 0) {
    sonidoUnirse();
  }
  cantidadJugadoresAnterior = jugadoresKeys.length;

  contador.textContent = jugadoresKeys.length;
  lista.innerHTML = '';

  jugadoresKeys.forEach((id) => {
    const li = document.createElement('li');
    const esYo = id == jugadorId;
    const esHostJugador = id == hostId;
    const nombreJugador = jugadores[id].nombre || 'Jugador sin nombre';
    const colorJugador = jugadores[id].color || '#78909C';

    let textoJugador = nombreJugador;
    if (esYo) textoJugador += ' (TÃº)';
    if (esHostJugador) textoJugador += ' (Host)';

    // AÃ±adir indicador de color
    const colorIndicator = document.createElement('span');
    colorIndicator.className = 'color-indicator';
    colorIndicator.style.backgroundColor = colorJugador;

    li.appendChild(colorIndicator);
    li.appendChild(document.createTextNode(textoJugador));

    // ğŸš¨ Si soy host y no es el host, hago interactuable el recuadro
    if (esHost && !esYo) {
      li.style.cursor = "pointer";
      li.addEventListener("click", () => {
        mostrarBotonKick(li, id, nombreJugador);
      });
    }

    lista.appendChild(li);
  });

  document.getElementById('jugadoresInfo').style.display = 'block';
}
    // ğŸš¨ Mostrar botÃ³n para kickear
    function mostrarBotonKick(li, jugadorKickId, nombreJugador) {
  if (li.querySelector(".btn-kick")) return; // ya existe botÃ³n

  const btn = document.createElement("button");
  btn.textContent = "Kickear";
  btn.className = "btn-kick";
  btn.style.marginLeft = "10px";
  btn.style.background = "linear-gradient(to right, #ff0000, #da411b)";
  btn.style.color = "#fff";
  btn.style.border = "none";
  btn.style.padding = "4px 8px";
  btn.style.borderRadius = "15px";
  btn.style.cursor = "pointer";

  btn.addEventListener("click", async (event) => {
    event.stopPropagation(); // evita duplicar clicks
    if (!salaActual) return;

    const salaRef = doc(db, "salas", salaActual);
    const snapshot = await getDoc(salaRef);
    const data = snapshot.data();
    if (!data) return;

    const nuevosJugadores = { ...data.jugadores };
    delete nuevosJugadores[jugadorKickId];

    await setDoc(salaRef, {
      ...data,
      jugadores: nuevosJugadores
    });

    alert(`${nombreJugador} fue kickeado de la sala.`);
  });

  li.appendChild(btn);
}
    // Crear selector de colores
    function crearSelectorColores() {
      const contenedorColores = document.getElementById('coloresDisponibles');
      contenedorColores.innerHTML = '';
      
      coloresJugadores.forEach(color => {
        const colorOption = document.createElement('div');
        colorOption.className = 'color-option';
        colorOption.style.backgroundColor = color;
        colorOption.dataset.color = color;
        
        colorOption.addEventListener('click', function() {
          // Deseleccionar todos los colores
          document.querySelectorAll('.color-option').forEach(opt => {
            opt.classList.remove('selected');
          });
          
          // Seleccionar este color
          this.classList.add('selected');
          miColor = color;
          
          // Actualizar el color en la base de datos
          if (salaActual) {
            const salaRef = doc(db, "salas", salaActual);
            updateDoc(salaRef, {
              [`jugadores.${jugadorId}.color`]: color
            });
          }
        });
        
        contenedorColores.appendChild(colorOption);
      });
    }

    // Configurar selector de modo de juego
    function configurarSelectorModo() {
      const opcionesModo = document.querySelectorAll('.modo-option');
      
      opcionesModo.forEach(opcion => {
        opcion.addEventListener('click', function() {
          // Reproducir sonido de selecciÃ³n
      sonidoSeleccionarModo();
          // Deseleccionar todas las opciones
          opcionesModo.forEach(opt => opt.classList.remove('selected'));
          
          // Seleccionar esta opciÃ³n
          this.classList.add('selected');
          modoJuego = this.dataset.modo;
          
          // Actualizar indicador de modo
          document.getElementById('modoTexto').textContent = 
            modoJuego === 'normal' ? 'Normal' : 'MÃ¡s Roles';
        });
      });
    }

    // FunciÃ³n para continuar a la selecciÃ³n de categorÃ­a despuÃ©s de elegir el modo
    window.continuarACategoria = function() {
      // Ocultar selector de modo
      document.getElementById("modoSelector").style.display = "none";
      
      // Mostrar selector de categorÃ­as
      toggleCategoriaSelector();
    };

    // FunciÃ³n para mostrar/ocultar selector de categorÃ­as
    window.toggleCategoriaSelector = function() {
  // Solo permitir al host cambiar la categorÃ­a
  if (!esHost && salaActual) {
    alert("Solo el host puede cambiar la categorÃ­a de la sala");
    return;
  }
  
  const container = document.getElementById('categoriaContainer');
  if (container.style.display === 'none' || container.style.display === '') {
    container.style.display = 'flex';
  } else {
    container.style.display = 'none';
  }
};

    // FunciÃ³n para confirmar la categorÃ­a seleccionada
    window.confirmarCategoria = function() {
  toggleCategoriaSelector();
  
  if (esHost) {
    // Si es host, actualizar en Firestore
    cambiarCategoria(categoriaJuego);
  } else {
    // Si no es host, solo actualizar localmente (pero no deberÃ­a poder cambiar)
    document.getElementById('categoriaTexto').textContent = obtenerNombreCategoria(categoriaJuego);
  }
  
  // ğŸš¨ IMPORTANTE: Si estamos creando una nueva sala, llamar a crearSalaConCategoria
  if (!salaActual && esHost) {
    crearSalaConCategoria();
  }
};

    // FunciÃ³n para configurar selector de categorÃ­as
    function configurarSelectorCategoria() {
      const opcionesCategoria = document.querySelectorAll('.categoria-option');
      
      opcionesCategoria.forEach(opcion => {
        opcion.addEventListener('click', function() {
          // Reproducir sonido de selecciÃ³n
      sonidoSeleccionarCategoria();
          // Deseleccionar todas las opciones
          opcionesCategoria.forEach(opt => opt.classList.remove('selected'));
          
          // Seleccionar esta opciÃ³n
          this.classList.add('selected');
          categoriaJuego = this.dataset.categoria;
        });
      });
    }

    // FunciÃ³n para obtener el nombre legible de una categorÃ­a
    function obtenerNombreCategoria(categoria) {
      const nombres = {
        aleatoria: "Aleatoria",
        actores: "Actores",
        series: "Series",
        videojuegos: "Videojuegos",
        anime: "Anime",
        artistas: "Artistas"
      };
      return nombres[categoria] || "Aleatoria";
    }

    // FunciÃ³n para obtener una palabra aleatoria segÃºn la categorÃ­a
    function obtenerPalabraAleatoria(categoria) {
      const listaPalabras = palabrasPorCategoria[categoria] || palabrasPorCategoria.aleatoria;
      return listaPalabras[Math.floor(Math.random() * listaPalabras.length)];
    }

    // FunciÃ³n para obtener una palabra diferente a la principal (para el confundido)
    function obtenerPalabraDiferente(palabraPrincipal, categoria) {
      const listaPalabras = palabrasPorCategoria[categoria] || palabrasPorCategoria.aleatoria;
      let palabraDiferente;
      do {
        palabraDiferente = listaPalabras[Math.floor(Math.random() * listaPalabras.length)];
      } while (palabraDiferente === palabraPrincipal && listaPalabras.length > 1);
      return palabraDiferente;
    }

// FunciÃ³n para que el host cambie la categorÃ­a
async function cambiarCategoria(nuevaCategoria) {
  if (!salaActual || !esHost) {
    return;
  }
  
  const salaRef = doc(db, "salas", salaActual);
  await updateDoc(salaRef, {
    categoria: nuevaCategoria
  });
  
  // Actualizar localmente
  categoriaJuego = nuevaCategoria;
  document.getElementById('categoriaTexto').textContent = obtenerNombreCategoria(nuevaCategoria);
}

    // Crear sala - MODIFICADA PARA MOSTRAR PRIMERO EL SELECTOR DE MODO
    window.crearSala = async function() {
      miNombre = document.getElementById("nombreJugador").value.trim();
      if (!miNombre) {
        alert("Por favor ingresa tu nombre");
        return;
      }
      esHost = true;
      // PRIMERO MOSTRAR SELECTOR DE MODO
      document.getElementById("modoSelector").style.display = "block";
      
      // OCULTAR ELEMENTOS DE ENTRADA
      document.getElementById("nombreJugador").style.display = "none";
      document.querySelector('button[onclick="crearSala()"]').style.display = "none";
      document.querySelector('button[onclick="unirseSala()"]').style.display = "none";
      document.getElementById("codigoSala").style.display = "none";
      
      document.getElementById("mensaje").innerText = "Selecciona el modo de juego y luego la categorÃ­a";
    };

    // FunciÃ³n para crear sala despuÃ©s de elegir categorÃ­a
    async function crearSalaConCategoria() {
      sonidoCrearSala();

      const codigo = Math.random().toString(36).substring(2, 7).toUpperCase();
      const palabra = obtenerPalabraAleatoria(categoriaJuego);
      const salaRef = doc(db, "salas", codigo);

      // Asignar un color por defecto
      miColor = coloresJugadores[Math.floor(Math.random() * coloresJugadores.length)];

      const jugadores = {};
      jugadores[jugadorId] = { 
        estado: "pendiente", 
        nombre: miNombre,
        color: miColor
      };

      await setDoc(salaRef, {
        palabra: palabra,
        impostor: null,
        jugadores: jugadores,
        mensajes: [],
        countdown: null,
        hostId: jugadorId,
        reacciones: [],
        modoJuego: modoJuego,
        categoria: categoriaJuego
      });

      salaActual = codigo;
      esHost = true;
      cantidadJugadoresAnterior = 1;
      
      // ACTUALIZAR LA URL CON EL CÃ“DIGO DE LA SALA
      const nuevaURL = window.location.origin + window.location.pathname + '?sala=' + codigo;
      history.pushState({ sala: codigo }, '', nuevaURL);
      
      // NUEVO: Mostrar URL completa
      mostrarURLCompleta();
      
      // MOSTRAR EL CÃ“DIGO DE SALA (solo el cÃ³digo, sin botÃ³n de copiar cÃ³digo)
      document.getElementById("codigoSalaDisplay").style.display = "block";
      document.getElementById("codigoTexto").textContent = codigo;
      
      // MOSTRAR INDICADOR DE CATEGORÃA
      document.getElementById("categoriaIndicator").style.display = "block";
      document.getElementById("categoriaTexto").textContent = obtenerNombreCategoria(categoriaJuego);
      
      // MOSTRAR INDICADOR DE MODO
      document.getElementById("modoIndicator").style.display = "block";
      document.getElementById("modoTexto").textContent = 
        modoJuego === 'normal' ? 'Normal' : 'MÃ¡s Roles';
      
      // MOSTRAR BOTÃ“N DE INFO DE ROLES (solo en modo MÃ¡s Roles)
      if (modoJuego === "masRoles") {
        document.getElementById('btnInfoRoles').style.display = 'inline-block';
      } else {
        document.getElementById('btnInfoRoles').style.display = 'none';
      }
      
      // MOSTRAR SELECTOR DE COLORES
      document.getElementById("colorSelector").style.display = "block";
      crearSelectorColores();
      
      // EL SELECTOR DE MODO YA ESTÃ OCULTO, NO HACE FALTA OCULTARLO DE NUEVO
      
      document.getElementById("botonAsignar").style.display = "inline-block";
      document.getElementById("modoSelector").style.display = "none";
      document.getElementById("mensaje").innerText = 
        "Sala creada. Comparte la URL con tus amigos. Esperando jugadores...";

      // Escuchar cambios
      onSnapshot(salaRef, (snap) => {
        const data = snap.data();
        if (data) {
          // ğŸš¨ Verificar si sigo en la sala (por ID)
          const sigoEnSala = data.jugadores && data.jugadores[jugadorId];

          if (!sigoEnSala) {
            localStorage.setItem("kickMessage", "Fuiste kickeado de la sala.");
            location.reload();
            return;
          }

          actualizarListaJugadores(data.jugadores, data.hostId);
          actualizarChat(data.mensajes);
          // Actualizar categorÃ­a cuando cambie
if (data.categoria && data.categoria !== categoriaJuego) {
  categoriaJuego = data.categoria;
  document.getElementById('categoriaTexto').textContent = obtenerNombreCategoria(categoriaJuego);
}

          // Escuchar reacciones
          if (data.reacciones && data.reacciones.length > 0) {
            const ultimaReaccion = data.reacciones[data.reacciones.length - 1];
            if (Date.now() - ultimaReaccion.timestamp < 2000) {
              mostrarReaccionFlotante(ultimaReaccion.nombre, ultimaReaccion.emoji);
            }
          }

          // Escuchar countdown
          if (data.countdown !== null && data.countdown !== undefined) {
            mostrarCountdownSincronizado(data.countdown);
          }

          const misDatos = data.jugadores[jugadorId];
          if (misDatos && misDatos.estado) {
            if (misDatos.estado === "pendiente") {
              // ğŸš¨ Volver al lobby si estamos en pendiente
              juegoIniciado = false;
              document.getElementById('chatContainer').style.display = 'none';
              document.getElementById("colorSelector").style.display = "block";
              document.getElementById("mensaje").innerText = "Esperando que el host inicie...";
              document.getElementById("botonNuevaRonda").style.display = "none";
            } else {
              // ğŸš¨ Juego en curso
              if (!juegoIniciado) {
                juegoIniciado = true;
                document.getElementById('chatContainer').style.display = 'flex';
                document.getElementById("colorSelector").style.display = "none";
                if (esHost) {
                  document.getElementById("botonNuevaRonda").style.display = "inline-block";
                }
              }
              document.getElementById("mensaje").innerText = "Tu rol es: " + misDatos.estado;
            }
          }
        }
      });
    }

    // Unirse a sala
window.unirseSala = async function() {
  miNombre = document.getElementById("nombreJugador").value.trim();
  if (!miNombre) {
    alert("Por favor ingresa tu nombre");
    return;
  }

  const codigo = document.getElementById("codigoSala").value.toUpperCase();
  const salaRef = doc(db, "salas", codigo);

  const snapshot = await getDoc(salaRef);
  if (!snapshot.exists()) {
    alert("Esa sala no existe");
    return;
  }

  const data = snapshot.data();
  const jugadores = data.jugadores || {};

  // ğŸš¨ Verificar si ya existe un jugador con ese nombre
  const nombreRepetido = Object.values(jugadores).some(j => j.nombre.toLowerCase() === miNombre.toLowerCase());
  if (nombreRepetido) {
    alert("Ese nombre ya estÃ¡ en uso en esta sala. Elige otro.");
    return;
  }

  salaActual = codigo;

  // Asignar un color por defecto
  miColor = coloresJugadores[Math.floor(Math.random() * coloresJugadores.length)];

  jugadores[jugadorId] = { 
    estado: "pendiente", 
    nombre: miNombre,
    color: miColor
  };

  // Obtener el modo de juego y la categorÃ­a de la sala
  modoJuego = data.modoJuego || "normal";
  categoriaJuego = data.categoria || "aleatoria";

  await updateDoc(salaRef, {
  jugadores: jugadores
});

      // ACTUALIZAR LA URL CON EL CÃ“DIGO DE LA SALA
      const nuevaURL = window.location.origin + window.location.pathname + '?sala=' + codigo;
      history.pushState({ sala: codigo }, '', nuevaURL);

      // NUEVO: Mostrar URL completa
      mostrarURLCompleta();

      document.getElementById("codigoSala").style.display = "none";
      document.getElementById("nombreJugador").style.display = "none";
      document.querySelector('button[onclick="crearSala()"]').style.display = "none";
      document.querySelector('button[onclick="unirseSala()"]').style.display = "none";

      // MOSTRAR EL CÃ“DIGO DE SALA (solo el cÃ³digo, sin botÃ³n de copiar cÃ³digo)
      const codigoDiv = document.getElementById("codigoSalaDisplay");
      codigoDiv.style.display = "block";
      document.getElementById("codigoTexto").textContent = codigo;

      // MOSTRAR INDICADOR DE MODO
      document.getElementById("modoIndicator").style.display = "block";
      document.getElementById("modoTexto").textContent = 
        modoJuego === 'normal' ? 'Normal' : 'MÃ¡s Roles';

      // MOSTRAR INDICADOR DE CATEGORÃA
      document.getElementById("categoriaIndicator").style.display = "block";
      document.getElementById("categoriaTexto").textContent = obtenerNombreCategoria(categoriaJuego);

      // MOSTRAR BOTÃ“N DE INFO DE ROLES (solo en modo MÃ¡s Roles)
      if (modoJuego === "masRoles") {
        document.getElementById('btnInfoRoles').style.display = 'inline-block';
      } else {
        document.getElementById('btnInfoRoles').style.display = 'none';
      }

      // MOSTRAR SELECTOR DE COLORES
      document.getElementById("colorSelector").style.display = "block";
      crearSelectorColores();

      document.getElementById("mensaje").innerText = 
        "Unido a sala " + codigo + ". Espera a que empiece el juego.";

      // Escuchar cambios
onSnapshot(salaRef, (snap) => {
  const data = snap.data();
  if (data) {
    // ğŸš¨ Verificar si sigo en la sala (por ID)
    const sigoEnSala = data.jugadores && data.jugadores[jugadorId];

    if (!sigoEnSala) {
  localStorage.setItem("kickMessage", "Fuiste kickeado de la sala.");
  location.reload();
  return;
}

    actualizarListaJugadores(data.jugadores, data.hostId);
    actualizarChat(data.mensajes);
    // Actualizar categorÃ­a cuando cambie
if (data.categoria && data.categoria !== categoriaJuego) {
  categoriaJuego = data.categoria;
  document.getElementById('categoriaTexto').textContent = obtenerNombreCategoria(categoriaJuego);
}

    // Escuchar reacciones
    if (data.reacciones && data.reacciones.length > 0) {
      const ultimaReaccion = data.reacciones[data.reacciones.length - 1];
      if (Date.now() - ultimaReaccion.timestamp < 2000) {
        mostrarReaccionFlotante(ultimaReaccion.nombre, ultimaReaccion.emoji);
      }
    }

    // Escuchar countdown
    if (data.countdown !== null && data.countdown !== undefined) {
      mostrarCountdownSincronizado(data.countdown);
    }

    const misDatos = data.jugadores[jugadorId];
if (misDatos && misDatos.estado) {
  if (misDatos.estado === "pendiente") {
    // ğŸš¨ Volver al lobby si estamos en pendiente
    juegoIniciado = false;
    document.getElementById('chatContainer').style.display = 'none';
    document.getElementById("colorSelector").style.display = "block";
    document.getElementById("mensaje").innerText = "Esperando que el host inicie...";
    document.getElementById("botonNuevaRonda").style.display = "none";
  } else {
    // ğŸš¨ Juego en curso
    if (!juegoIniciado) {
      juegoIniciado = true;
      document.getElementById('chatContainer').style.display = 'flex';
      document.getElementById("colorSelector").style.display = "none";
      if (esHost) {
        document.getElementById("botonNuevaRonda").style.display = "inline-block";
      }
    }
    document.getElementById("mensaje").innerText = "Tu rol es: " + misDatos.estado;
  }
}
  }
});
    };

    // Asignar roles - CORREGIDO
    window.asignarRoles = async function() {
      if (!salaActual) {
        alert("Primero crea o Ãºnete a una sala");
        return;
      }

      const salaRef = doc(db, "salas", salaActual);
      const snapshot = await getDoc(salaRef);
      const data = snapshot.data();
      const jugadores = Object.keys(data.jugadores);
      
      // ğŸš¨ CORRECCIÃ“N: Usar la categorÃ­a de la sala actual
      const categoriaActual = data.categoria || "aleatoria";

      if (jugadores.length < 3) {
        alert("Necesitan al menos 3 jugadores");
        return;
      }

      sonidoAsignarRoles();

      // Elegir roles segÃºn el modo de juego
      let nuevosRoles = {};
      const palabraPrincipal = obtenerPalabraAleatoria(categoriaActual);
      
      if (modoJuego === "normal") {
        // Modo normal: 1 impostor, el resto con la misma palabra
        const impostorIndex = Math.floor(Math.random() * jugadores.length);
        
        jugadores.forEach((id, i) => {
          const jugadorData = data.jugadores[id];
          nuevosRoles[id] = {
            estado: (i === impostorIndex) ? "IMPOSTOR" : palabraPrincipal,
            nombre: jugadorData.nombre,
            color: jugadorData.color
          };
        });
      } else {
        // Modo MÃ¡s Roles: impostor, confundido, saboteador, y el resto con la palabra principal
        const indicesDisponibles = [...Array(jugadores.length).keys()];
        
        // Elegir impostor
        const impostorIndex = Math.floor(Math.random() * indicesDisponibles.length);
        const impostorId = indicesDisponibles.splice(impostorIndex, 1)[0];
        
        // Elegir confundido (si hay al menos 4 jugadores)
        let confundidoIndex = -1;
        if (indicesDisponibles.length >= 3) {
          confundidoIndex = Math.floor(Math.random() * indicesDisponibles.length);
          const confundidoId = indicesDisponibles.splice(confundidoIndex, 1)[0];
        }
        
        // Elegir saboteador (si hay al menos 5 jugadores)
        let saboteadorIndex = -1;
        if (indicesDisponibles.length >= 2) {
          saboteadorIndex = Math.floor(Math.random() * indicesDisponibles.length);
          const saboteadorId = indicesDisponibles.splice(saboteadorIndex, 1)[0];
        }
        
        // Asignar roles
        jugadores.forEach((id, i) => {
          const jugadorData = data.jugadores[id];
          let rol = palabraPrincipal;
          
          if (i === impostorId) {
            rol = "IMPOSTOR";
          } else if (i === confundidoId) {
            // El confundido recibe una palabra diferente de la misma categorÃ­a
            let palabraConfundido;
            do {
              palabraConfundido = obtenerPalabraAleatoria(categoriaActual);
            } while (palabraConfundido === palabraPrincipal);
            rol = `CONFUNDIDO: ${palabraConfundido}`;
          } else if (i === saboteadorId) {
            rol = `SABOTEADOR: ${palabraPrincipal}`;
          }
          
          nuevosRoles[id] = {
            estado: rol,
            nombre: jugadorData.nombre,
            color: jugadorData.color
          };
        });
      }

      // Ejecutar countdown
      let count = 3;
      
      const intervalo = setInterval(async () => {
        if (count >= 0) {
          await updateDoc(salaRef, { countdown: count });
          count--;
        } else {
          clearInterval(intervalo);
          
          // Asignar roles despuÃ©s del countdown
          setTimeout(async () => {
            await setDoc(salaRef, {
              palabra: palabraPrincipal,
              impostor: Object.keys(nuevosRoles).find(id => nuevosRoles[id].estado === "IMPOSTOR"),
              jugadores: nuevosRoles,
              mensajes: data.mensajes || [],
              countdown: -1,
              hostId: data.hostId,
              reacciones: data.reacciones || [],
              modoJuego: modoJuego,
              categoria: categoriaActual // ğŸš¨ CORRECCIÃ“N: Preservar categorÃ­a
            });
            
            juegoIniciado = true;
          }, 1000);
        }
      }, 1000);
    };

    // Nueva ronda - CORREGIDO
    window.nuevaRonda = async function() {
      if (!salaActual || !esHost) {
        alert("Solo el host puede iniciar una nueva ronda");
        return;
      }

      sonidoNuevaRonda();

      const salaRef = doc(db, "salas", salaActual);
      const snapshot = await getDoc(salaRef);
      const data = snapshot.data();
      const jugadores = Object.keys(data.jugadores);
      
      // ğŸš¨ CORRECCIÃ“N: Usar la categorÃ­a actual de la sala
      const categoriaActual = data.categoria || "aleatoria";

      if (jugadores.length < 3) {
        alert("Necesitan al menos 3 jugadores");
        return;
      }

      // ğŸš¨ CORRECCIÃ“N: Usar la categorÃ­a actual para la nueva palabra
      const nuevaPalabra = obtenerPalabraAleatoria(categoriaActual);

      // Resetear estados
      let nuevosEstados = {};
      jugadores.forEach(id => {
        const jugadorData = data.jugadores[id];
        nuevosEstados[id] = {
          estado: "pendiente",
          nombre: jugadorData.nombre,
          color: jugadorData.color
        };
      });

      // ğŸš¨ CORRECCIÃ“N: Arreglar la sintaxis
      await setDoc(salaRef, {
        palabra: nuevaPalabra,
        impostor: null,
        jugadores: nuevosEstados,
        mensajes: [], // ğŸš¨ limpiar el chat en cada nueva ronda
        countdown: null,
        hostId: data.hostId,
        reacciones: [],
        modoJuego: data.modoJuego, // ğŸš¨ CORRECCIÃ“N: Coma agregada
        categoria: data.categoria // ğŸš¨ CORRECCIÃ“N: Preservar la categorÃ­a
      });

      juegoIniciado = false;
      document.getElementById("mensaje").innerText = 
        "Nueva ronda. Esperando jugadores...";
      document.getElementById("botonAsignar").style.display = "inline-block";
      document.getElementById("colorSelector").style.display = "block";
      document.getElementById("botonNuevaRonda").style.display = "none"; // ğŸš¨ CORRECCIÃ“N: Ocultar botÃ³n
    };

    // FunciÃ³n para verificar si hay una sala en la URL al cargar
    function verificarSalaEnURL() {
      const urlParams = new URLSearchParams(window.location.search);
      const salaParam = urlParams.get('sala');
      
      if (salaParam) {
        // Si hay una sala en la URL, rellenar automÃ¡ticamente el campo y mostrar mensaje
        document.getElementById('codigoSala').value = salaParam;
        document.getElementById('mensaje').innerText = 'Se detectÃ³ una sala en la URL. Ingresa tu nombre y haz clic en "Unirse"';
      }
    }

    window.addEventListener('DOMContentLoaded', function() {
      // Verificar si hay una sala en la URL al cargar
      verificarSalaEnURL();
      
      // ğŸš¨ Mostrar mensaje si fui kickeado
  const msg = localStorage.getItem("kickMessage");
  if (msg) {
    alert(msg);
    localStorage.removeItem("kickMessage"); // limpiar para no repetir
  }
     // SÃ­mbolos animados    
      const container = document.getElementById('symbols');
      const simbolos = ['?', '!', '!?', 'â“', 'â”', 'â—', 'â•', 'â€¼ï¸', 'â‰ï¸'];
      const elementos = [];
      
      for (let i = 0; i < 8; i++) {
        const symbol = document.createElement('div');
        symbol.className = 'symbol';
        symbol.textContent = simbolos[Math.floor(Math.random() * simbolos.length)];
        
        const x = Math.random() * (window.innerWidth - 50);
        const y = Math.random() * (window.innerHeight - 50);
        const velocidadX = (Math.random() - 0.5) * 4;
        const velocidadY = (Math.random() - 0.5) * 4;
        
        symbol.style.left = x + 'px';
        symbol.style.top = y + 'px';
        
        container.appendChild(symbol);
        
        elementos.push({
          element: symbol,
          x: x,
          y: y,
          vx: velocidadX,
          vy: velocidadY,
          rotation: Math.random() * 360,
          rotationSpeed: (Math.random() - 0.5) * 2
        });
      }
      
      function animar() {
        elementos.forEach(item => {
          item.x += item.vx;
          item.y += item.vy;
          item.rotation += item.rotationSpeed;
          
          if (item.x <= 0 || item.x >= window.innerWidth - 50) {
            item.vx *= -1;
            item.x = Math.max(0, Math.min(item.x, window.innerWidth - 50));
          }
          
          if (item.y <= 0 || item.y >= window.innerHeight - 50) {
            item.vy *= -1;
            item.y = Math.max(0, Math.min(item.y, window.innerHeight - 50));
          }
          
          item.element.style.left = item.x + 'px';
          item.element.style.top = item.y + 'px';
          item.element.style.transform = `rotate(${item.rotation}deg)`;
        });
        
        requestAnimationFrame(animar);
      }
      
      animar();
      
       // Configurar selectores de modo y categorÃ­a
      configurarSelectorModo();
      configurarSelectorCategoria();
    });
  </script>
  <script>
    // Toggle tema (fuera del modulo para que sea accesible globalmente)
    function toggleTheme() {
      document.body.classList.toggle('light-mode');
      const btn = document.getElementById('themeToggle');
      if (document.body.classList.contains('light-mode')) {
        btn.innerHTML = '&#127769;'; // Luna
      } else {
        btn.innerHTML = '&#9728;&#65039;'; // Sol
      }
    }
  </script>
</body>
</html>