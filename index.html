<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Juego del Impostor</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico?v=2">
  <style>
    :root {
      --bg-primary: #222;
      --bg-secondary: #333;
      --bg-tertiary: #444;
      --text-primary: #fff;
      --text-secondary: #4cafef;
      --button-bg: #4cafef;
      --button-text: #111;
      --shadow: rgba(255,255,255,0.2);
    }
    
    body.light-mode {
      --bg-primary: #f5f5f5;
      --bg-secondary: #ffffff;
      --bg-tertiary: #e0e0e0;
      --text-primary: #222;
      --text-secondary: #2196F3;
      --button-bg: #2196F3;
      --button-text: #fff;
      --shadow: rgba(0,0,0,0.1);
    }
    
    body {
      font-family: Arial, sans-serif;
      background: #B8B8FC;
      color: var(--text-primary);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;             /* mantenemos altura de viewport para que la tarjeta siempre entre */
      margin: 0;
      overflow: hidden;          /* evitamos scroll de página */
      position: relative;
      transition: background 0.3s ease;
    }
    
    /* Mesh Gradient Background */
    .mesh-gradient {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #4facfe 75%, #00f2fe 100%);
      background-size: 400% 400%;
      animation: meshMove 15s ease infinite;
    }
    
    body.light-mode .mesh-gradient {
      background: linear-gradient(135deg, #a8edea 0%, #fed6e3 25%, #ffecd2 50%, #fcb69f 75%, #ffeaa7 100%);
      background-size: 400% 400%;
    }
    
    @keyframes meshMove {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    /* Blobs decorativos */
    .blob { position: fixed; border-radius: 50%; filter: blur(80px); opacity: 0.5; z-index: -1; animation: blobFloat 20s ease-in-out infinite; }
    .blob1 { width: 400px; height: 400px; background: radial-gradient(circle, rgba(102, 126, 234, 0.8) 0%, rgba(118, 75, 162, 0.4) 100%); top: -100px; left: -100px; animation-delay: 0s; }
    .blob2 { width: 350px; height: 350px; background: radial-gradient(circle, rgba(240, 147, 251, 0.8) 0%, rgba(245, 87, 108, 0.4) 100%); bottom: -100px; right: -100px; animation-delay: 7s; }
    .blob3 { width: 300px; height: 300px; background: radial-gradient(circle, rgba(79, 172, 254, 0.8) 0%, rgba(0, 242, 254, 0.4) 100%); top: 50%; right: -50px; animation-delay: 14s; }
    body.light-mode .blob1 { background: radial-gradient(circle, rgba(168, 237, 234, 0.6) 0%, rgba(254, 214, 227, 0.3) 100%); }
    body.light-mode .blob2 { background: radial-gradient(circle, rgba(255, 236, 210, 0.6) 0%, rgba(252, 182, 159, 0.3) 100%); }
    body.light-mode .blob3 { background: radial-gradient(circle, rgba(255, 234, 167, 0.6) 0%, rgba(168, 237, 234, 0.3) 100%); }
    @keyframes blobFloat { 0%,100% { transform: translate(0,0) scale(1);} 33% { transform: translate(30px,-50px) scale(1.1);} 66% { transform: translate(-20px,20px) scale(0.9);} }
    
    .background-symbols { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; }
    .symbol { position: absolute; font-size: 40px; opacity: 0.4; color: var(--text-primary); pointer-events: none; text-shadow: 0 2px 10px rgba(0,0,0,0.3); transition: opacity 0.3s ease; }
    body.light-mode .symbol { opacity: 0.25; text-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    
    /* Toggle Theme Button */
    .theme-toggle { position: fixed; top: 20px; right: 20px; z-index: 1000; background: var(--bg-secondary); border: none; border-radius: 50%; width: 50px; height: 50px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 10px var(--shadow); transition: all 0.3s ease; }
    .theme-toggle:hover { transform: scale(1.1); box-shadow: 0 6px 15px var(--shadow); }
    
    /* ---------- MODIFICADO: tarjeta que siempre entra en pantalla ---------- */
    .card {
      background: var(--bg-primary);
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      width: 350px;
      max-height: 90vh;          /* <-- MODIFICADO: nunca supera 90% del viewport */
      display: flex;             /* <-- MODIFICADO: layout interno por columnas */
      flex-direction: column;
      box-shadow: 0px 0px 20px var(--shadow);
      position: relative;
      z-index: 1;
      backdrop-filter: blur(10px);
      transition: background 0.3s ease, box-shadow 0.3s ease;
      overflow: hidden;          /* <-- MODIFICADO: evita overflow fuera de la tarjeta */
    }
    /* --------------------------------------------------------------------- */
    
    body.light-mode .card { box-shadow: 0px 0px 30px rgba(0,0,0,0.15); }
    
    input, button {
      margin: 10px;
      padding: 10px;
      border-radius: 8px;
      border: none;
      font-size: 16px;
      transition: all 0.3s ease;
    }
    button { cursor: pointer; background: var(--button-bg); color: var(--button-text); font-weight: bold; }
    button:hover { transform: translateY(-2px); box-shadow: 0 4px 8px var(--shadow); }
    #botonAsignar { display: none; }
    #mensaje { white-space: pre-line; color: var(--text-primary); }
    
    .jugadores-info {
      margin-top: 15px;
      padding: 10px;
      background: var(--bg-secondary);
      border-radius: 8px;
      display: none;
      transition: background 0.3s ease;
      flex: 1 1 auto;            /* <-- MODIFICADO: ocupa espacio flexible dentro de la tarjeta */
      overflow-y: auto;          /* <-- MODIFICADO: scroll interno si hay muchos jugadores */
      min-height: 60px;          /* evita que se colapse demasiado */
    }
    .jugadores-info h3 {
      margin: 5px 0;
      font-size: 16px;
      color: var(--text-secondary);
      position: sticky;
      top: 0;
      background: transparent;
      padding-bottom: 6px;
      z-index: 2;
    }
    .lista-jugadores {
      list-style: none;
      padding: 0;
      margin: 10px 0;
      /* dejamos que el contenedor .jugadores-info controle el scroll */
    }
    .lista-jugadores li {
      padding: 5px;
      margin: 3px 0;
      background: var(--bg-tertiary);
      border-radius: 5px;
      font-size: 14px;
      color: var(--text-primary);
      transition: background 0.3s ease;
    }
    .lista-jugadores::-webkit-scrollbar { width: 6px; }
    .lista-jugadores::-webkit-scrollbar-thumb { background: var(--text-secondary); border-radius: 4px; }
    
    .codigo-sala {
      display: none;
      margin: 10px 0;
      padding: 10px;
      background: var(--bg-secondary);
      border-radius: 8px;
      transition: background 0.3s ease;
    }
    .codigo-sala span { font-size: 24px; font-weight: bold; color: var(--text-secondary); letter-spacing: 2px; }
    .btn-copiar { background: #5cb85c; margin-left: 10px; padding: 8px 15px; font-size: 14px; color: #fff; }
    .btn-copiar:hover { background: #4cae4c; }
    
    input[type="text"] {
      width: calc(100% - 40px);
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 2px solid transparent;
      transition: all 0.3s ease;
    }
    input[type="text"]:focus { outline: none; border-color: var(--text-secondary); }
    #botonNuevaRonda { display: none; background: #f39c12; margin-top: 10px; }
    #botonNuevaRonda:hover { background: #e67e22; }
    
    /* chat: mantenemos también scroll interno y dejamos que ocupe espacio flexible */
    .chat-container {
      display: none;
      margin-top: 15px;
      background: var(--bg-secondary);
      border-radius: 8px;
      padding: 10px;
      flex: 1 1 auto;            /* <-- MODIFICADO: ocupa espacio flexible */
      min-height: 120px;
      overflow-y: auto;          /* <-- MODIFICADO: scroll interno si hay muchos mensajes */
      transition: background 0.3s ease;
    }
    .chat-messages {
      min-height: 120px;
      max-height: none; /* dejamos que el contenedor chat se encargue del scroll */
      overflow-y: auto;
      background: var(--bg-primary);
      padding: 8px;
      border-radius: 5px;
      margin-bottom: 8px;
      font-size: 13px;
      text-align: left;
      transition: background 0.3s ease;
    }
    .chat-message { margin: 5px 0; padding: 4px; border-radius: 3px; background: var(--bg-tertiary); color: var(--text-primary); transition: background 0.3s ease; }
    .chat-message strong { color: var(--text-secondary); }
    .chat-input-container { display: flex; gap: 5px; }
    .chat-input-container input { flex: 1; margin: 0; width: auto; }
    .chat-input-container button { margin: 0; padding: 8px 15px; }
    
    .reacciones-container { display: flex; gap: 8px; justify-content: center; margin-top: 8px; flex-wrap: wrap; }
    .btn-reaccion { background: var(--bg-tertiary); border: 2px solid var(--text-secondary); border-radius: 50%; width: 45px; height: 45px; font-size: 22px; padding: 0; margin: 0; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; }
    .btn-reaccion:hover { transform: scale(1.2); background: var(--text-secondary); box-shadow: 0 0 15px var(--text-secondary); }
    .btn-reaccion:active { transform: scale(0.9); }
    
    .reaccion-flotante { position: fixed; font-size: 60px; pointer-events: none; z-index: 10000; animation: reaccionFloat 2s ease-out forwards; }
    .reaccion-nombre { position: absolute; bottom: -25px; left: 50%; transform: translateX(-50%); background: var(--bg-primary); padding: 4px 8px; border-radius: 5px; font-size: 12px; white-space: nowrap; color: var(--text-secondary); font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
    @keyframes reaccionFloat { 0% { opacity: 0; transform: translateY(0) scale(0.5); } 10% { opacity: 1; transform: translateY(-20px) scale(1.2); } 50% { opacity: 1; transform: translateY(-100px) scale(1); } 100% { opacity: 0; transform: translateY(-200px) scale(0.8); } }
    
    .countdown-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); display: none; justify-content: center; align-items: center; z-index: 9999; }
    .countdown-number { font-size: 150px; font-weight: bold; color: #ff3333; text-shadow: 0 0 30px rgba(255, 51, 51, 0.8); }
    @keyframes countdownPulse { 0% { transform: scale(0.5); opacity: 0; } 50% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }

  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAnQJm-YfIgkz5HZ8ebkPqaxRICapy98N8",
      authDomain: "juego-impostor-88c68.firebaseapp.com",
      projectId: "juego-impostor-88c68",
      storageBucket: "juego-impostor-88c68.firebasestorage.app",
      messagingSenderId: "433056214911",
      appId: "1:433056214911:web:81d9f175213b4a7861f44a",
      measurementId: "G-3PKRDYMX8F"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

   const palabras = [
"Scarlett Johansson", "Tom Holland", "Zendaya", "Chris Hemsworth", "Emma Watson", "Robert Downey Jr.", "Margot Robbie", "Dwayne Johnson", "Gal Gadot", "Timothée Chalamet", "Florence Pugh", "Will Smith", "Chris Evans", "Ryan Reynolds", "Millie Bobby Brown", "Billie Eilish", "Ariana Grande", "Harry Styles", "Taylor Swift", "Dua Lipa", "Drake", "Ed Sheeran", "Rosalía", "BTS", "Travis Scott", "The Weeknd", "Lady Gaga", "Olivia Rodrigo", "Selena Gomez", "Post Malone", "Justin Bieber", "Rick (Rick y Morty)", "Morty", "Bob Esponja", "Patricio estrella", "Finn", "Jake", "Gumball", "Darwin", "Homero Simpson", "Marge Simpson", "Bart Simpson", "Lisa Simpson", "Walter White", "Jesse Pinkman", "Skyler White", "Tony Stark", "Peter Parker", "Loki", "Wanda Maximoff", "Doctor Strange", "Black Panther", "Harry Potter", "Mario", "Luigi", "Bowser", "Sonic", "Tails", "Knuckles", "Pikachu", "Ash Ketchum", "Goku", "Vegeta", "Bulma", "Naruto", "Sasuke", "Sakura", "Luffy", "Messi", "Nigi", "Lautaro", "Lucas", "Luciano", "Rubio", "Esteban", "Gladinir", "Luciana", "Santi", "Pasado Alterno", "Dexter"
];

    let salaActual = null;
    let jugadorId = Math.floor(Math.random() * 1000000);
    let esHost = false;
    let miNombre = "";
    let cantidadJugadoresAnterior = 0;
    let juegoIniciado = false;
    let audioContext = null;
    let ultimoCountdown = null;

    // Inicializar contexto de audio
    function inicializarAudio() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
      if (audioContext.state === 'suspended') {
        audioContext.resume();
      }
    }

    // Sonidos
    function reproducirSonido(frecuencia, duracion) {
      try {
        inicializarAudio();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = frecuencia;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duracion);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + duracion);
      } catch (error) {
        console.log('Error al reproducir sonido:', error);
      }
    }

    function sonidoUnirse() {
      reproducirSonido(600, 0.2);
      setTimeout(() => reproducirSonido(800, 0.2), 100);
    }

    function sonidoCrearSala() {
      reproducirSonido(523, 0.15);
      setTimeout(() => reproducirSonido(659, 0.15), 80);
      setTimeout(() => reproducirSonido(784, 0.25), 160);
    }

    function sonidoCopiar() {
      reproducirSonido(800, 0.1);
      setTimeout(() => reproducirSonido(1000, 0.15), 50);
    }

    function sonidoAsignarRoles() {
      reproducirSonido(440, 0.2);
      setTimeout(() => reproducirSonido(392, 0.2), 150);
      setTimeout(() => reproducirSonido(349, 0.2), 300);
      setTimeout(() => reproducirSonido(330, 0.4), 450);
    }

    function sonidoNuevaRonda() {
      reproducirSonido(698, 0.15);
      setTimeout(() => reproducirSonido(784, 0.15), 100);
      setTimeout(() => reproducirSonido(880, 0.2), 200);
    }

    function sonidoCountdown() {
      reproducirSonido(600, 0.3);
    }

    function sonidoCountdownFinal() {
      reproducirSonido(800, 0.15);
      setTimeout(() => reproducirSonido(1000, 0.3), 100);
    }

    function sonidoReaccion() {
      reproducirSonido(800, 0.1);
      setTimeout(() => reproducirSonido(1000, 0.1), 80);
    }

    // Mostrar countdown sincronizado
    function mostrarCountdownSincronizado(valor) {
      const overlay = document.getElementById('countdownOverlay');
      const numberElement = document.getElementById('countdownNumber');
      
      console.log('Countdown valor recibido:', valor);
      
      if (valor === null || valor === -1) {
        overlay.style.display = 'none';
        ultimoCountdown = null;
        return;
      }
      
      // Solo actualizar si el valor cambió
      if (ultimoCountdown === valor) return;
      ultimoCountdown = valor;
      
      overlay.style.display = 'flex';
      
      if (valor === 0) {
        numberElement.textContent = '¡COMIENZA!';
        sonidoCountdownFinal();
      } else {
        numberElement.textContent = valor;
        sonidoCountdown();
      }
      
      // Reiniciar animación
      numberElement.style.animation = 'none';
      void numberElement.offsetWidth;
      numberElement.style.animation = 'countdownPulse 1s ease-out';
    }

    // Copiar código
    window.copiarCodigo = function() {
      if (!salaActual) return;
      sonidoCopiar();
      navigator.clipboard.writeText(salaActual).then(() => {
        const btn = document.querySelector('.btn-copiar');
        const textoOriginal = btn.textContent;
        btn.textContent = '✓ Copiado!';
        setTimeout(() => {
          btn.textContent = textoOriginal;
        }, 2000);
      });
    };

    // Enviar reacción
    window.enviarReaccion = async function(emoji) {
      if (!salaActual) return;
      
      sonidoReaccion();
      
      const salaRef = doc(db, "salas", salaActual);
      await updateDoc(salaRef, {
        reacciones: arrayUnion({
          nombre: miNombre,
          emoji: emoji,
          timestamp: Date.now()
        })
      });
    };

    // Mostrar reacción flotante
    function mostrarReaccionFlotante(nombre, emoji) {
      const reaccion = document.createElement('div');
      reaccion.className = 'reaccion-flotante';
      reaccion.textContent = emoji;
      
      const nombreDiv = document.createElement('div');
      nombreDiv.className = 'reaccion-nombre';
      nombreDiv.textContent = nombre;
      reaccion.appendChild(nombreDiv);
      
      // Posición aleatoria en la parte inferior-central de la pantalla
      const x = window.innerWidth / 2 + (Math.random() - 0.5) * 400;
      const y = window.innerHeight - 150;
      
      reaccion.style.left = x + 'px';
      reaccion.style.top = y + 'px';
      
      document.body.appendChild(reaccion);
      
      setTimeout(() => {
        reaccion.remove();
      }, 2000);
    }

    // Enviar mensaje al chat
    window.enviarMensaje = async function() {
      const input = document.getElementById('chatInput');
      const mensaje = input.value.trim();
      
      if (!mensaje || !salaActual) return;
      
      const salaRef = doc(db, "salas", salaActual);
      await updateDoc(salaRef, {
        mensajes: arrayUnion({
          nombre: miNombre,
          texto: mensaje,
          timestamp: Date.now()
        })
      });
      
      input.value = '';
    };

    window.handleChatKeyPress = function(event) {
      if (event.key === 'Enter') {
        enviarMensaje();
      }
    };

    // Actualizar chat
    function actualizarChat(mensajes) {
      if (!mensajes) return;
      const chatDiv = document.getElementById('chatMessages');
      chatDiv.innerHTML = '';
      const mensajesRecientes = mensajes.slice(-20);
      mensajesRecientes.forEach(msg => {
        const div = document.createElement('div');
        div.className = 'chat-message';
        div.innerHTML = `<strong>${msg.nombre}:</strong> ${msg.texto}`;
        chatDiv.appendChild(div);
      });
      chatDiv.scrollTop = chatDiv.scrollHeight;
    }

    // Actualizar lista de jugadores
    function actualizarListaJugadores(jugadores, hostId) {
      const lista = document.getElementById('listaJugadores');
      const contador = document.getElementById('contadorJugadores');
      const jugadoresKeys = Object.keys(jugadores);
      
      if (jugadoresKeys.length > cantidadJugadoresAnterior && cantidadJugadoresAnterior > 0) {
        sonidoUnirse();
      }
      cantidadJugadoresAnterior = jugadoresKeys.length;
      
      contador.textContent = jugadoresKeys.length;
      lista.innerHTML = '';
      
      jugadoresKeys.forEach((id) => {
        const li = document.createElement('li');
        const esYo = id == jugadorId;
        const esHostJugador = id == hostId;
        const nombreJugador = jugadores[id].nombre || 'Jugador sin nombre';
        
        let textoJugador = nombreJugador;
        if (esYo) textoJugador += ' (Tú)';
        if (esHostJugador) textoJugador += ' (Host)';
        
        li.textContent = textoJugador;
        lista.appendChild(li);
      });
      
      document.getElementById('jugadoresInfo').style.display = 'block';
    }

    // Crear sala
    window.crearSala = async function() {
      miNombre = document.getElementById("nombreJugador").value.trim();
      if (!miNombre) {
        alert("Por favor ingresa tu nombre");
        return;
      }

      sonidoCrearSala();

      const codigo = Math.random().toString(36).substring(2, 7).toUpperCase();
      const palabra = palabras[Math.floor(Math.random() * palabras.length)];
      const salaRef = doc(db, "salas", codigo);

      const jugadores = {};
      jugadores[jugadorId] = { estado: "pendiente", nombre: miNombre };

      await setDoc(salaRef, {
        palabra: palabra,
        impostor: null,
        jugadores: jugadores,
        mensajes: [],
        countdown: null,
        hostId: jugadorId,
        reacciones: []
      });

      salaActual = codigo;
      esHost = true;
      cantidadJugadoresAnterior = 1;
      document.getElementById("botonAsignar").style.display = "inline-block";
      document.getElementById("codigoSala").style.display = "none";
      document.getElementById("nombreJugador").style.display = "none";
      document.querySelector('button[onclick="crearSala()"]').style.display = "none";
      document.querySelector('button[onclick="unirseSala()"]').style.display = "none";
      
      const codigoDiv = document.getElementById("codigoSalaDisplay");
      codigoDiv.style.display = "block";
      document.getElementById("codigoTexto").textContent = codigo;
      
      document.getElementById("mensaje").innerText = 
        "Sala creada. Comparte el código con tus amigos. Esperando jugadores...";

      // Escuchar cambios
      onSnapshot(salaRef, (snap) => {
        const data = snap.data();
        if (data) {
          actualizarListaJugadores(data.jugadores, data.hostId);
          actualizarChat(data.mensajes);
          
          // Escuchar reacciones
          if (data.reacciones && data.reacciones.length > 0) {
            const ultimaReaccion = data.reacciones[data.reacciones.length - 1];
            // Solo mostrar si es reciente (menos de 2 segundos)
            if (Date.now() - ultimaReaccion.timestamp < 2000) {
              mostrarReaccionFlotante(ultimaReaccion.nombre, ultimaReaccion.emoji);
            }
          }
          
          // Escuchar countdown
          if (data.countdown !== null && data.countdown !== undefined) {
            mostrarCountdownSincronizado(data.countdown);
          }
          
          const misDatos = data.jugadores[jugadorId];
          if (misDatos && misDatos.estado && misDatos.estado !== "pendiente") {
            if (!juegoIniciado) {
              juegoIniciado = true;
              document.getElementById('chatContainer').style.display = 'block';
              if (esHost) {
                document.getElementById("botonNuevaRonda").style.display = "inline-block";
              }
            }
            document.getElementById("mensaje").innerText = 
              "La palabra es: " + misDatos.estado;
          }
        }
      });
    };

    // Unirse a sala
    window.unirseSala = async function() {
      miNombre = document.getElementById("nombreJugador").value.trim();
      if (!miNombre) {
        alert("Por favor ingresa tu nombre");
        return;
      }

      const codigo = document.getElementById("codigoSala").value.toUpperCase();
      const salaRef = doc(db, "salas", codigo);

      const snapshot = await getDoc(salaRef);
      if (!snapshot.exists()) {
        alert("Esa sala no existe");
        return;
      }

      salaActual = codigo;

      const data = snapshot.data();
      const jugadores = data.jugadores || {};
      jugadores[jugadorId] = { estado: "pendiente", nombre: miNombre };

      await setDoc(salaRef, {
        palabra: data.palabra,
        impostor: data.impostor,
        jugadores,
        mensajes: data.mensajes || [],
        countdown: data.countdown || null,
        hostId: data.hostId,
        reacciones: data.reacciones || []
      });

      document.getElementById("codigoSala").style.display = "none";
      document.getElementById("nombreJugador").style.display = "none";
      document.querySelector('button[onclick="crearSala()"]').style.display = "none";
      document.querySelector('button[onclick="unirseSala()"]').style.display = "none";

      const codigoDiv = document.getElementById("codigoSalaDisplay");
      codigoDiv.style.display = "block";
      document.getElementById("codigoTexto").textContent = codigo;

      document.getElementById("mensaje").innerText = 
        "Unido a sala " + codigo + ". Espera a que empiece el juego.";

      // Escuchar cambios
      onSnapshot(salaRef, (snap) => {
        const data = snap.data();
        if (data) {
          actualizarListaJugadores(data.jugadores, data.hostId);
          actualizarChat(data.mensajes);
          
          // Escuchar reacciones
          if (data.reacciones && data.reacciones.length > 0) {
            const ultimaReaccion = data.reacciones[data.reacciones.length - 1];
            // Solo mostrar si es reciente (menos de 2 segundos)
            if (Date.now() - ultimaReaccion.timestamp < 2000) {
              mostrarReaccionFlotante(ultimaReaccion.nombre, ultimaReaccion.emoji);
            }
          }
          
          // Escuchar countdown
          if (data.countdown !== null && data.countdown !== undefined) {
            mostrarCountdownSincronizado(data.countdown);
          }
          
          const misDatos = data.jugadores[jugadorId];
          if (misDatos && misDatos.estado && misDatos.estado !== "pendiente") {
            if (!juegoIniciado) {
              juegoIniciado = true;
              document.getElementById('chatContainer').style.display = 'block';
            }
            document.getElementById("mensaje").innerText = 
              "La palabra es: " + misDatos.estado;
          }
        }
      });
    };

    // Asignar roles
    window.asignarRoles = async function() {
      if (!salaActual) {
        alert("Primero crea o únete a una sala");
        return;
      }

      const salaRef = doc(db, "salas", salaActual);
      const snapshot = await getDoc(salaRef);
      const data = snapshot.data();
      const jugadores = Object.keys(data.jugadores);

      if (jugadores.length < 3) {
        alert("Necesitan al menos 3 jugadores");
        return;
      }

      sonidoAsignarRoles();

      // Elegir impostor
      const impostorIndex = Math.floor(Math.random() * jugadores.length);
      const impostorId = jugadores[impostorIndex];

      let nuevosRoles = {};
      jugadores.forEach((id, i) => {
        const jugadorData = data.jugadores[id];
        nuevosRoles[id] = {
          estado: (i === impostorIndex) ? "IMPOSTOR" : data.palabra,
          nombre: jugadorData.nombre
        };
      });

      // Ejecutar countdown
      let count = 3;
      
      const intervalo = setInterval(async () => {
        if (count >= 0) {
          await updateDoc(salaRef, { countdown: count });
          count--;
        } else {
          clearInterval(intervalo);
          
          // Asignar roles después del countdown
          setTimeout(async () => {
            await setDoc(salaRef, {
              palabra: data.palabra,
              impostor: impostorId,
              jugadores: nuevosRoles,
              mensajes: data.mensajes || [],
              countdown: -1,
              hostId: data.hostId,
              reacciones: data.reacciones || []
            });
            
            juegoIniciado = true;
          }, 1000);
        }
      }, 1000);
    };

    // Nueva ronda
    window.nuevaRonda = async function() {
      if (!salaActual || !esHost) {
        alert("Solo el host puede iniciar una nueva ronda");
        return;
      }

      sonidoNuevaRonda();

      const salaRef = doc(db, "salas", salaActual);
      const snapshot = await getDoc(salaRef);
      const data = snapshot.data();
      const jugadores = Object.keys(data.jugadores);

      if (jugadores.length < 3) {
        alert("Necesitan al menos 3 jugadores");
        return;
      }

      const nuevaPalabra = palabras[Math.floor(Math.random() * palabras.length)];
      const impostorIndex = Math.floor(Math.random() * jugadores.length);
      const impostorId = jugadores[impostorIndex];

      let nuevosRoles = {};
      jugadores.forEach((id, i) => {
        const jugadorData = data.jugadores[id];
        nuevosRoles[id] = {
          estado: (i === impostorIndex) ? "IMPOSTOR" : nuevaPalabra,
          nombre: jugadorData.nombre
        };
      });

      // Ejecutar countdown
      let count = 3;
      
      const intervalo = setInterval(async () => {
        if (count >= 0) {
          await updateDoc(salaRef, { countdown: count });
          count--;
        } else {
          clearInterval(intervalo);
          
          setTimeout(async () => {
            await setDoc(salaRef, {
              palabra: nuevaPalabra,
              impostor: impostorId,
              jugadores: nuevosRoles,
              mensajes: data.mensajes || [],
              countdown: -1,
              hostId: data.hostId,
              reacciones: data.reacciones || []
            });
          }, 1000);
        }
      }, 1000);
    };

    // Símbolos animados
    window.addEventListener('DOMContentLoaded', function() {
      const container = document.getElementById('symbols');
      const simbolos = ['?', '!', '!?', '❓', '❔', '❗​', '❕​', '‼️', '⁉️​'];
      const elementos = [];
      
      for (let i = 0; i < 8; i++) {
        const symbol = document.createElement('div');
        symbol.className = 'symbol';
        symbol.textContent = simbolos[Math.floor(Math.random() * simbolos.length)];
        
        const x = Math.random() * (window.innerWidth - 50);
        const y = Math.random() * (window.innerHeight - 50);
        const velocidadX = (Math.random() - 0.5) * 4;
        const velocidadY = (Math.random() - 0.5) * 4;
        
        symbol.style.left = x + 'px';
        symbol.style.top = y + 'px';
        
        container.appendChild(symbol);
        
        elementos.push({
          element: symbol,
          x: x,
          y: y,
          vx: velocidadX,
          vy: velocidadY,
          rotation: Math.random() * 360,
          rotationSpeed: (Math.random() - 0.5) * 2
        });
      }
      
      function animar() {
        elementos.forEach(item => {
          item.x += item.vx;
          item.y += item.vy;
          item.rotation += item.rotationSpeed;
          
          if (item.x <= 0 || item.x >= window.innerWidth - 50) {
            item.vx *= -1;
            item.x = Math.max(0, Math.min(item.x, window.innerWidth - 50));
          }
          
          if (item.y <= 0 || item.y >= window.innerHeight - 50) {
            item.vy *= -1;
            item.y = Math.max(0, Math.min(item.y, window.innerHeight - 50));
          }
          
          item.element.style.left = item.x + 'px';
          item.element.style.top = item.y + 'px';
          item.element.style.transform = `rotate(${item.rotation}deg)`;
        });
        
        requestAnimationFrame(animar);
      }
      
      animar();
    });
  </script>
  <script>
    // Toggle tema (fuera del modulo para que sea accesible globalmente)
    function toggleTheme() {
      document.body.classList.toggle('light-mode');
      const btn = document.getElementById('themeToggle');
      if (document.body.classList.contains('light-mode')) {
        btn.innerHTML = '&#127769;'; // Luna
      } else {
        btn.innerHTML = '&#9728;&#65039;'; // Sol
      }
    }
  </script>
</head>
<body>
  <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()">&#9728;&#65039;</button>
  <div class="mesh-gradient"></div>
  <div class="blob blob1"></div>
  <div class="blob blob2"></div>
  <div class="blob blob3"></div>
  <div class="countdown-overlay" id="countdownOverlay">
    <div class="countdown-number" id="countdownNumber">3</div>
  </div>
  <div class="background-symbols" id="symbols"></div>
  <div class="card">
    <h2>Juego del Impostor</h2>
    <p id="mensaje">Crea una sala o únete con un código</p>
    
    <div class="codigo-sala" id="codigoSalaDisplay">
      <span id="codigoTexto"></span>
      <button class="btn-copiar" onclick="copiarCodigo()">📋 Copiar</button>
    </div>
    
    <div class="jugadores-info" id="jugadoresInfo">
      <h3>Jugadores en sala: <span id="contadorJugadores">0</span></h3>
      <ul class="lista-jugadores" id="listaJugadores"></ul>
    </div>
    
    <input id="nombreJugador" type="text" placeholder="Tu nombre"><br>
    <button onclick="crearSala()">Crear Sala</button><br>
    <input id="codigoSala" placeholder="Código de sala">
    <button onclick="unirseSala()">Unirse</button><br>
    <button id="botonAsignar" onclick="asignarRoles()">Asignar Roles (Host)</button>
    <button id="botonNuevaRonda" onclick="nuevaRonda()">🔄 Nueva Ronda</button>
    
    <div class="chat-container" id="chatContainer">
      <div class="chat-messages" id="chatMessages"></div>
      <div class="reacciones-container">
        <button class="btn-reaccion" onclick="enviarReaccion('👍')" title="Me gusta">👍</button>
        <button class="btn-reaccion" onclick="enviarReaccion('👎')" title="No me gusta">👎</button>
        <button class="btn-reaccion" onclick="enviarReaccion('🤔')" title="Sospechoso">🤔</button>
        <button class="btn-reaccion" onclick="enviarReaccion('😱')" title="Sorpresa">😱</button>
        <button class="btn-reaccion" onclick="enviarReaccion('🤣​')" title="Risa">🤣​</button>
        <button class="btn-reaccion" onclick="enviarReaccion('☠️')" title="Calavera">☠️</button>
      </div>
      <div class="chat-input-container">
        <input id="chatInput" type="text" placeholder="Escribe un mensaje..." onkeypress="handleChatKeyPress(event)">
        <button onclick="enviarMensaje()">Enviar</button>
      </div>
    </div>
  </div>
</body>
</html>
